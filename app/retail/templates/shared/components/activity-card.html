{% comment %}
    Copyright (C) 2021 Gitcoin Core

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program. If not, see <http://www.gnu.org/licenses/>.

{% endcomment %}

{% load humanize i18n static grants_extra slug %}
<!-- TEMPLATE like-button -->
<script type="text/x-template" id="like-button">
  <button class="btn btn-sm" :class="{'animate-sparkle text-highlight-pink': data.viewer_reactions.like}" @click="likeActivity"><i class="far fa-heart" :class="data.viewer_reactions.like ? 'fas' : 'far'"></i> [[data.likes_count]]</button>
</script>

<!-- TEMPLATE activity-comment -->
<script type="text/x-template" id="activity-comment">
  <div class="d-flex flex-fill">

    <div>
      <img :src="item.profile.avatar_url || `/dynamic/avatar/${item.profile.handle}`" alt="" class="rounded-circle" height="40" width="40">
    </div>

    <div class="flex-fill ml-3">
      <div class="">
        <div class="d-flex justify-content-between">
          <div class="">
            <span class="font-weight-bold">[[item.profile.name]]</span>
            <a :href="item.profile.handle" class=""  :data-usercard="item.profile.handle">@[[item.profile.handle]]</a>
          </div>
          <time class="" :datetime="[[ item.created_on ]]" :title="[[ item.created_on ]]">
            [[ item.created_on | moment-fromnow ]] <i class="small" v-if="item.is_edited">edited</i>
          </time>
        </div>
        <div v-if="isEditing" class="mt-3">
          <textarea class="mb-2 form-control enter-activity-comment" :ref="`textArea-${index}`" id="" cols="100" rows="3" autofocus v-model="editedComment">[[editedComment]]</textarea>
          <button class="btn btn-sm btn-danger" @click="toggleEdit(index)">Cancel</button>
          <button class="btn btn-sm btn-primary" @click="editComment(item.id, index)">Send</button>
        </div>
        <div v-else>
          [[item.comment]]
        </div>
      </div>

      <div class="d-flex align-items-center comment_options font-smaller-5 mt-1" :class="{'invisible': isEditing}">
        <template v-if="item.is_owner">
          <button class="btn btn-sm" @click="toggleEdit(index)">
            <i class="fas fa-edit grey"></i>
          </button>
          <button class="btn btn-sm" @click="deleteComment(item.id)">
            <i class="fas fa-trash grey"></i>
          </button>
        </template>
        <like-button :data="item" api="comments" :id="item.id"></like-button>

        <!-- <button class="btn btn-sm" data-toggle="tooltip" :title="item.likes_handles.length ? `Liked by ${item.likes_handles}` : 'Liked by no one. Click to be the first.'">
          <i class="far fa-heart grey"></i>
          <span class="like_count">[[item.likes.length]]</span>
        </button> -->
        <button class="btn btn-sm">
          <i class="fab fa-ethereum grey"></i>
          <span class="grey">[[Math.round(1000 * item.tip_count_eth) / 1000]]</span>
        </button>

      </div>
    </div>
  </div>
</script>

<!-- TEMPLATE activity-card -->
<script type="text/x-template" id="activity-card">

  <div class="border-bottom d-flex flex-wrap py-3">

    <div class="d-flex flex-fill w-100 mb-3">
      <div class="d-flex flex-column align-items-center position-relative">
        <img :src="data.profile.avatar_url || `/dynamic/avatar/${data.profile.handle}`" alt="" class="rounded-circle" height="72" width="72">
        <img :src="data.metadata.url" alt="" class="rounded-circle secondary_avatar position-absolute" height="32" width="32" style="top:50px; right: 0;" v-if="data.metadata.url">

        <div class="">
          <img :src="`/dynamic/avatar/${org}`" alt="" class="rounded-circle" height="15" width="15" v-for="org in data.profile.organizations">
        </div>
      </div>
      <div class="d-flex flex-column flex-fill justify-content-between ml-3">
        <div class="d-flex justify-content-between">
          <div class="">
            <span class="font-weight-bold">[[data.profile.name]]</span>
            <a :href="data.profile.handle" class=""  :data-usercard="data.profile.handle">@[[data.profile.handle]]</a>
          </div>
          <time class="" :datetime="[[ data.created ]]" :title="[[ data.created ]]">
            [[ data.created | moment-fromnow ]]
          </time>
        </div>
        [[data.metadata.title]] <a :href="data.metadata.ask" v-if="data.metadata.ask !== 'undefined'">[[data.metadata.ask]]</a>
        <template v-if="data.activity_type!=='status_update'">
          [[data.humanized_activity_type]]
        </template>

        <div class="">
          <span class="btn btn-sm cursor-none" data-toggle="tooltip" title="The number of views this post has gotten."><i class="far fa-eye"></i> [[data.view_count]]</span>

          <span class="btn btn-sm cursor-none"><i class="far fa-comment"></i> [[data.comments_count]]</span>
          <like-button :data="data" api="activities" :id="data.pk"></like-button>
          <!-- <button class="btn btn-sm" :class="{'animate-sparkle text-highlight-pink': data.viewer_reactions.like}" @click="likeActivity"><i class="far fa-heart" :class="data.viewer_reactions.like ? 'fas' : 'far'"></i> [[data.likes_count]]</button> -->
          <button class="btn btn-sm"><i class="fab fa-ethereum grey"></i> [[data.tip]]</button>
          <b-dropdown size="sm"  variant="link" toggle-class="text-decoration-none" no-caret menu-class="font-smaller-5">
            <template #button-content>
              <i class="fas fa-ellipsis-h grey"></i><span class="sr-only">more</span>
            </template>
            <b-dropdown-item href="#"><i class="fas fa-fw fa-map-pin mr-2"></i> Pin post</b-dropdown-item>


            <li role="presentation">
              <copy-clipboard class="dropdown-item" :string="linkSingle"><i class="fas fa-fw fa-link mr-2"></i> Copy link</copy-clipboard>
            </li>
            <!-- <b-dropdown-item href="#"><i class="fas fa-fw fa-link mr-2"></i> Copy link</b-dropdown-item> -->
            <b-dropdown-item href="#"><i class="far fa-fw fa-star mr-2"></i> Favorite</b-dropdown-item>
            <b-dropdown-item href="#"><i class="far fa-fw fa-flag mr-2"></i> Report</b-dropdown-item>
            <b-dropdown-item href="#"><i class="fas fa-fw fa-trash mr-2"></i> Delete</b-dropdown-item>
          </b-dropdown>

        </div>
      </div>
    </div>

    <div v-if="data.metadata.poll_choices" v-for="choice in data.metadata.poll_choices" class="w-100">
      <div class="border p-2 m-1">[[ choice.question ]]</div>
    </div>


    <div class="embed-responsive embed-responsive-16by9 mt-2" v-if="data.metadata.resource && data.metadata.resource.provider == 'youtube'">
      <iframe class="embed-responsive-item" height="315" :src="`https://www.youtube.com/embed/${data.metadata.resource.id}`"
      frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen></iframe>
    </div>

    <div v-if="data.metadata.resource && data.metadata.resource.type == 'content'" class="d-flex bg-light w-100 p-3">

      <img class="mw-100" width="96" :src="data.metadata.resource.image || `{% static 'v2/images/team/gitcoinbot.png' %}`">
      <div class="ml-3">
        <span class="mt-2 mb-1 font-weight-bold">[[data.metadata.resource.title]]</span>
        <p class="small">[[data.metadata.resource.description]]</p>
        <a :href="data.metadata.resource.provider" target="_blank" rel="nofollow" style="color: #0056b3" class="d-block">[[data.metadata.resource.provider]]</a>
      </div>

    </div>

    <div class="w-100" v-else-if="data?.metadata?.resource?.type == 'gif'">
      <img class="w-100" loading="lazy" :src="data.metadata.resource.id" style="max-height: 450px; object-fit: contain;">
    </div>


    <button class="btn btn-block btn-link bg-lightpurple" :disabled="loadingComments" v-if="Object.keys(data.comments).length < data.comments_count" @click="fetchComments(data.pk)">Load more comments ([[data.comments_count - Object.keys(data.comments).length ]])</button>
    <div v-for="(item, index) in commentsByDate" class="d-flex flex-fill w-100 px-3 py-2 bg-lightblue" v-if="Object.keys(data.comments[0]).length" :key="item.id">
      <activity-comment :item="item" :index="index" v-on:update:commentUpdate="updateEvent"></activity-comment>

    </div>
    <div class="bg-lightblue p-3" :id="`comments-${index}`" >
      <div class="d-flex">
        <div>
          <img :src="`/dynamic/avatar/${github_handle}`" alt="" class="rounded-circle" height="40" width="40">
        </div>
        <div class="ml-3 text-right">
          <textarea class="mb-2 form-control enter-activity-comment" name="newcomment" id="" cols="100" rows="3" v-model="data.newComment">[[data.newComment]]</textarea>
          <button @click="postComment" :disabled="!data.newComment" class="btn btn-sm btn-primary">Comment</button>
        </div>
      </div>
    </div>


  </div>

</script>
